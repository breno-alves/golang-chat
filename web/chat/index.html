<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
    <style>
        .wrapper {
            display: flex;
            justify-content: center;
            align-content: center;
            width: 100%;
            height: 100%;
        }

        .container {
            width: 1024px;
            height: 1024px;
        }

        .account-container {
            display: flex;
            justify-content: space-between;
            padding-bottom: 32px;
            border-bottom: 1px solid black;
        }

        .sub-container {
            display: flex;
            justify-content: space-between;
        }

        .chat {

            width: 60%;
        }

        .messages {
            width: 100%;
            height: 100%;
            border: 3px solid red;
            padding: 32px;
        }

        .message {
            width: 100%;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid blue;
            margin: 8px;
        }

        .rooms {
            width: 33%;
            height: 100%;
            background-color: black;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div class="container">
        <div class="account-container">
            <div class="login">
                <h3>Login</h3>

                <label>
                    Username:
                    <input type="text" id="login-username"/>
                </label>

                <label>
                    Password:
                    <input type="password" id="login-password"/>
                </label>

                <button onclick="login()">Submit</button>
            </div>
            <div class="register">
                <h3>Register</h3>
                <label>
                    Username:
                    <input type="text" id="signup-username"/>
                </label>

                <label>
                    Password:
                    <input type="password" id="signup-password"/>
                </label>
                <button onclick="signup()">Submit</button>
            </div>
        </div>

        <div class="sub-container">
            <div class="chat">
                <!-- CONTAINER TO DISPLAY NEW MESSAGES -->
                <div class="messages">
                </div>
                <!-- END -->
                <div>
                    <input type="text" id="message-box"/>
                    <button onclick="sendMessage()">Submit</button>
                </div>
            </div>
            <div class="rooms">
                <ol>
                    <li>test</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!--<h1>WebSocket Client</h1>-->
<!--<div>-->
<!--    <input type="text" id="messageInput" placeholder="Enter your message">-->
<!--    <button onclick="sendMessage()">Send</button>-->
<!--</div>-->
<!--<div id="messages"></div>-->

<script>
  const ACTIONS = {
    CREATE_ROOM: "CREATE_ROOM",
    JOIN_ROOM: "JOIN_ROOM",
    LEAVE_ROOM: "LEAVE_ROOM",
    SEND_MESSAGE: "SEND_MESSAGE"
  };

  // let token = null;
  let token = "1435a686-32cc-4227-85cc-deea1928ca7f"
  let currentRoom = 1;
  let ws = null;

  function login() {
    const username = document.querySelector("#login-username").value;
    const password = document.querySelector("#login-password").value;

    fetch("http://localhost:8080/auth/login", {
      method: 'POST',
      body: JSON.stringify(
        {
          username: username,
          password: password,
        }
      ),
    })
      .then((response) => response.json())
      .then((data) => {
        token = data.username;
      });
  }

  function signup() {
    const username = document.querySelector("#signup-username").value;
    const password = document.querySelector("#signup-password").value;

    fetch("http://localhost:8080/user", {
      method: 'POST',
      body: JSON.stringify(
        {
          username: username,
          password: password,
        }
      ),
    })
      .then((response) => response.json())
      .then((data) => {
        token = data.username;
      });
  }

  function sendMessage() {
    let input = document.getElementById("message-box");
    let message = input.value;
    ws.send(parseMessage(ACTIONS.SEND_MESSAGE, {content: message, room: currentRoom}));
    input.value = "";
  }

  function newMessage(message) {
    let messageDisplay = document.querySelector(".messages");
    messageDisplay.insertAdjacentHTML("beforeend", `
          <div class="message">
            <p>${message.owner_id}</p>
            <p>${message.content}</p>
          </div>
        `);
  }

  function connect() {
    ws = new WebSocket("ws://localhost:8080/ws");

    ws.onopen = function () {
      console.log("Connected to WebSocket server");
    };

    ws.onmessage = function (event) {
      newMessage(JSON.parse(event.data));
    };

    ws.onclose = function () {
      console.log("WebSocket connection closed, retrying...");
      setTimeout(connect, 1000); // Reconnect after 1 second
    };

    ws.onerror = function (error) {
      console.error("WebSocket error:", error);
    };
  }

  function parseMessage(action, payload) {
    let parsedMessage = {
      action: action,
      payload: payload,
      token: token
    };
    return JSON.stringify(parsedMessage);
  }


  connect();
</script>
</body>
</html>